<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Problems Categorizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        h1 { 
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .navbar {
            background: #f8f9fa;
            border-bottom: 2px solid #e1e5e9;
            padding: 10px 0;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .nav-tab {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            margin: 5px;
        }
        .nav-tab:hover {
            color: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .nav-tab.active {
            color: white;
            background: #667eea;
            border-color: #667eea;
        }
        .content {
            padding: 30px;
            background: #f0f2f5;
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #667eea;
            font-size: 18px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 16px;
            color: #666;
        }
        .sync-time {
            color: #28a745;
            font-weight: 600;
            margin-left: 10px;
        }
        .posts-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .post {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e1e5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }
        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            border-color: #667eea;
        }
        .post-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        .post-content {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 13px;
            color: #999;
            flex-wrap: wrap;
            gap: 10px;
        }
        .post-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .category-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        .severity-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .severity-high {
            background: #dc3545;
            color: white;
        }
        .severity-medium {
            background: #ffc107;
            color: #000;
        }
        .severity-low {
            background: #28a745;
            color: white;
        }
        .nav-tab.severity-high-tab.active {
            background: #dc3545;
            border-color: #dc3545;
        }
        .nav-tab.severity-medium-tab.active {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        .nav-tab.severity-low-tab.active {
            background: #28a745;
            border-color: #28a745;
        }
        .dropdown-container {
            position: relative;
            display: inline-block;
            margin: 5px;
        }
        .dropdown-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: 2px solid #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dropdown-btn:hover {
            transform: translateY(-2px);
            background: #5568d3;
        }
        .dropdown-btn::after {
            content: '‚ñº';
            font-size: 10px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            padding: 12px 0;
            z-index: 1;
            border-radius: 8px;
            top: 100%;
            left: 0;
            margin-top: 8px;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            color: #333;
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .dropdown-item:hover {
            background-color: #f1f1f1;
            padding-left: 20px;
        }
        .dropdown-item.active {
            background-color: #667eea;
            color: white;
        }
        .timestamp {
            color: #28a745;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .content { padding: 20px; }
            h1 { font-size: 2rem; }
            .controls { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>College Problems Categorizer</h1>
            <p class="subtitle">Real-time analysis of problems from r/college</p>
        </div>
        
        <div class="controls">
            <button id="fetchBtn">Fetch Latest Problems</button>
            <button id="analyzeBtn">Analyze Data</button>
        </div>

        <div class="navbar">
            <div class="nav-tabs">
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="sortBtn">üî• Hot</button>
                    <div class="dropdown-content" id="sortDropdown">
                        <div class="dropdown-item active" data-sort="hot">üî• Hot</div>
                        <div class="dropdown-item" data-sort="new">‚ú® New</div>
                        <div class="dropdown-item" data-sort="top">‚¨ÜÔ∏è Top</div>
                        <div class="dropdown-item" data-sort="rising">üìà Rising</div>
                    </div>
                </div>
                <button class="nav-tab" id="sortAllBox">üìã All</button>
                <button class="nav-tab" data-category="Academic Issues">Academic Issues</button>
                <button class="nav-tab" data-category="Financial Problems">Financial Problems</button>
                <button class="nav-tab" data-category="Housing & Accommodation">Housing & Accommodation</button>
                <button class="nav-tab" data-category="Social & Relationships">Social & Relationships</button>
                <button class="nav-tab" data-category="Mental Health">Mental Health</button>
                <button class="nav-tab" data-category="Food & Dining">Food & Dining</button>
                <button class="nav-tab" data-category="Transportation">Transportation</button>
                <button class="nav-tab" data-category="Other">Other</button>
            </div>
        </div>
        
        <div class="navbar">
            <div class="nav-tabs">
                <button class="nav-tab active" data-severity="All">üî• All Severity</button>
                <button class="nav-tab severity-high-tab" data-severity="High">üö® High Severity</button>
                <button class="nav-tab severity-medium-tab" data-severity="Medium">‚ö†Ô∏è Medium Severity</button>
                <button class="nav-tab severity-low-tab" data-severity="Low">üí° Low Severity</button>
            </div>
        </div>
        
        <div class="content">
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Fetching latest posts from r/college and categorizing...</p>
            </div>
            
            <div id="stats" class="stats" style="display: none;"></div>
            <div id="posts" class="posts-container"></div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let allPosts = [];
        let currentFilter = 'All';
        let currentSeverityFilter = 'All';
        let currentSort = 'hot';
        
        const categoryNames = [
            'Academic Issues',
            'Financial Problems',
            'Housing & Accommodation',
            'Social & Relationships',
            'Mental Health',
            'Food & Dining',
            'Transportation',
            'Other'
        ];

        document.getElementById('fetchBtn').addEventListener('click', fetchAndCategorize);
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            if (allPosts.length === 0) {
                alert('Please fetch data first!');
                return;
            }
            // Store data in localStorage and redirect
            localStorage.setItem('collegeProblemsData', JSON.stringify(allPosts));
            window.location.href = 'analytics.html';
        });
        
        // Toggle dropdown menu
        document.getElementById('sortBtn').addEventListener('click', () => {
            document.getElementById('sortDropdown').classList.toggle('show');
        });
        
        const sortLabels = {
            hot: 'üî• Hot',
            new: '‚ú® New',
            top: '‚¨ÜÔ∏è Top',
            rising: 'üìà Rising'
        };

        const sortBtn = document.getElementById('sortBtn');
        const sortAllBox = document.getElementById('sortAllBox');

        // Handle sort selection
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const newSort = e.target.dataset.sort;
                applySort(newSort);
            });
        });

        // All box to reset to the default feed
        sortAllBox.addEventListener('click', () => {
            applySort('hot', true);
        });

        function applySort(newSort, viaAllBox = false) {
            currentSort = newSort;

            // Update dropdown active states
            document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`.dropdown-item[data-sort="${newSort}"]`);
            if (activeItem) activeItem.classList.add('active');

            // Update labels
            sortBtn.textContent = sortLabels[newSort] || 'üî• Hot';

            // Toggle All box active class
            sortAllBox.classList.toggle('active', viaAllBox);
            if (!viaAllBox) {
                sortAllBox.classList.remove('active');
            }

            // Close dropdown
            document.getElementById('sortDropdown').classList.remove('show');

            // Fetch fresh data for the chosen sort
            fetchAndCategorize();
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.matches('#sortBtn') && !e.target.closest('.dropdown-container')) {
                document.getElementById('sortDropdown').classList.remove('show');
            }
        });
        
        // Enable category filters
        document.querySelectorAll('.nav-tab[data-category]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                currentFilter = e.target.dataset.category;
                updateActiveCategoryTab(e.target);
                displayPosts();
            });
        });

        // Enable severity filters
        document.querySelectorAll('.nav-tab[data-severity]').forEach(tab => {
            tab.addEventListener('click', (e) => {
                currentSeverityFilter = e.target.dataset.severity;
                updateActiveSeverityTab(e.target);
                displayPosts();
            });
        });
        
        function updateActiveCategoryTab(activeTab) {
            document.querySelectorAll('.nav-tab[data-category]').forEach(t => t.classList.remove('active'));
            activeTab.classList.add('active');
        }

        function updateActiveSeverityTab(activeTab) {
            document.querySelectorAll('.nav-tab[data-severity]').forEach(t => t.classList.remove('active'));
            activeTab.classList.add('active');
        }
        
        function categorizeSeverity(post) {
            const text = (post.title + ' ' + post.content).toLowerCase();
            const severityKeywords = {
                high: ['failing', 'crisis', 'emergency', 'desperate', 'suicidal', 'broke', 'evicted', 'depressed', 'anxiety attack', 'kicked out', 'homeless', 'dropping out'],
                medium: ['struggling', 'difficult', 'worried', 'stressed', 'anxious', 'problem', 'concerned', 'trouble', 'hard time', 'overwhelmed'],
                low: ['advice', 'help', 'question', 'wondering', 'considering', 'tips', 'suggestions', 'recommendations']
            };
            
            if (severityKeywords.high.some(keyword => text.includes(keyword))) {
                return 'High';
            } else if (severityKeywords.medium.some(keyword => text.includes(keyword))) {
                return 'Medium';
            } else {
                return 'Low';
            }
        }

        async function fetchAndCategorize() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('fetchBtn').disabled = true;
            
            try {
                console.log('Starting fetch...');
                const posts = await fetchRedditPosts();
                console.log('Fetched posts:', posts.length, posts);
                
                allPosts = await categorizeProblems(posts);
                console.log('All posts after categorization:', allPosts);
                
                displayPosts();
                updateTimestamp();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = '<p>Error: ' + error.message + '</p>';
            } finally {
                document.getElementById('fetchBtn').disabled = false;
            }
        }

        async function fetchRedditPosts() {
            const url = `http://localhost:3000/api/reddit/college?sort=${currentSort}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Server error');
            
            const data = await response.json();
            console.log('Total Reddit posts received:', data.data.children.length);
            
            const filtered = data.data.children
                .map(post => post.data)
                .filter(post => post.selftext && post.selftext.length > 30 && !post.stickied);
            
            console.log('Posts after filtering:', filtered.length);
            
            return filtered.map(post => ({
                title: post.title,
                content: post.selftext,
                shortContent: post.selftext.substring(0, 300) + (post.selftext.length > 300 ? '...' : ''),
                author: post.author,
                score: post.score,
                created: new Date(post.created_utc * 1000)
            }));
        }

        async function categorizeProblems(posts) {
            const categorizedPosts = [];
            
            for (const post of posts) {
                // Skip AI for now, use fallback categorization
                const categories = [fallbackCategorize(post)];
                const severity = categorizeSeverity(post);
                categorizedPosts.push({
                    ...post,
                    categories: categories,
                    severity: severity
                });
                console.log('Categorized post:', post.title, 'as', categories, 'severity:', severity);
            }
            
            return categorizedPosts;
        }

        async function categorizeWithAI(post) {
            try {
                const response = await fetch('http://localhost:5000/api/categorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        posts: [{
                            title: post.title,
                            content: post.content
                        }]
                    })
                });

                if (!response.ok) return fallbackCategorize(post);

                const data = await response.json();
                const category = data[0].category;
                const categories = category.split(',').map(cat => cat.trim()).filter(cat => categoryNames.includes(cat));
                
                return categories.length > 0 ? categories : [fallbackCategorize(post)];
            } catch (error) {
                return [fallbackCategorize(post)];
            }
        }

        function fallbackCategorize(post) {
            const text = (post.title + ' ' + post.content).toLowerCase();
            
            if (text.includes('grade') || text.includes('exam') || text.includes('study') || text.includes('class')) {
                return 'Academic Issues';
            }
            if (text.includes('money') || text.includes('loan') || text.includes('debt') || text.includes('afford')) {
                return 'Financial Problems';
            }
            if (text.includes('roommate') || text.includes('dorm') || text.includes('housing')) {
                return 'Housing & Accommodation';
            }
            if (text.includes('friend') || text.includes('relationship') || text.includes('social')) {
                return 'Social & Relationships';
            }
            if (text.includes('anxiety') || text.includes('stress') || text.includes('mental') || text.includes('depressed')) {
                return 'Mental Health';
            }
            if (text.includes('food') || text.includes('meal') || text.includes('dining')) {
                return 'Food & Dining';
            }
            if (text.includes('transport') || text.includes('bus') || text.includes('commute')) {
                return 'Transportation';
            }
            return 'Other';
        }

        function displayPosts() {
            document.getElementById('loading').style.display = 'none';
            
            const container = document.getElementById('posts');
            container.innerHTML = '';
            container.style.display = 'block';
            container.style.background = '';
            container.style.minHeight = '';
            container.style.border = '';
            
            let filteredPosts = allPosts;
            if (currentFilter !== 'All') {
                filteredPosts = allPosts.filter(post => post.categories.includes(currentFilter));
            }
            if (currentSeverityFilter !== 'All') {
                filteredPosts = filteredPosts.filter(post => post.severity === currentSeverityFilter);
            }
            
            // Hide stats
            document.getElementById('stats').style.display = 'none';
            
            // Update navbar with counts
            updateNavbarCounts();

            console.log('Displaying posts:', filteredPosts.length);
            
            if (filteredPosts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666; background: white; border-radius: 10px;">No posts found.</div>';
                return;
            }

            filteredPosts.forEach((post, index) => {
                const postDiv = document.createElement('div');
                postDiv.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 20px;
                    border: 2px solid #667eea;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    cursor: pointer;
                `;
                
                const isExpanded = post.expanded || false;
                const contentToShow = isExpanded ? post.content : post.shortContent;
                const expandText = isExpanded ? 'Show Less' : 'Show More';
                
                const severityClass = `severity-${post.severity.toLowerCase()}`;
                const severityIcon = post.severity === 'High' ? 'üö®' : post.severity === 'Medium' ? '‚ö†Ô∏è' : 'üí°';
                
                postDiv.innerHTML = `
                    <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 12px;">${escapeHtml(post.title)}</div>
                    <div class="post-content-area" style="color: #666; line-height: 1.6; margin-bottom: 15px;">${escapeHtml(contentToShow)}</div>
                    ${post.content.length > 300 ? `<div class="expand-btn" style="color: #667eea; font-size: 14px; font-weight: 600; margin-bottom: 15px; cursor: pointer;">${expandText}</div>` : ''}
                    <div style="font-size: 13px; color: #999; margin-bottom: 15px;">
                        <span>üë§ u/${post.author}</span>
                        <span style="margin-left: 15px;">‚¨ÜÔ∏è ${post.score}</span>
                        <span style="margin-left: 15px;">üïí ${formatTime(post.created)}</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span class="severity-badge ${severityClass}">${severityIcon} ${post.severity} Severity</span>
                        ${post.categories.map(cat => `<span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;">${cat}</span>`).join('')}
                    </div>
                `;
                
                // Add click handler for expand/collapse
                const expandBtn = postDiv.querySelector('.expand-btn');
                if (expandBtn) {
                    expandBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        post.expanded = !post.expanded;
                        displayPosts(); // Refresh display
                    });
                }
                
                container.appendChild(postDiv);
                console.log('Added post to container:', post.title);
            });
        }

        function updateActiveTab(activeTab) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            activeTab.classList.add('active');
        }

        function updateNavbarCounts() {
            const categoryCounts = {
                'All': allPosts.length,
                'Academic Issues': 0,
                'Financial Problems': 0,
                'Housing & Accommodation': 0,
                'Social & Relationships': 0,
                'Mental Health': 0,
                'Food & Dining': 0,
                'Transportation': 0,
                'Other': 0
            };
            
            const severityCounts = {
                'All': allPosts.length,
                'High': 0,
                'Medium': 0,
                'Low': 0
            };
            
            allPosts.forEach(post => {
                post.categories.forEach(category => {
                    if (categoryCounts[category] !== undefined) {
                        categoryCounts[category]++;
                    }
                });
                
                if (post.severity && severityCounts[post.severity] !== undefined) {
                    severityCounts[post.severity]++;
                }
            });
            
            // Update category tabs
            document.querySelectorAll('.nav-tab[data-category]').forEach(tab => {
                const category = tab.dataset.category;
                const count = categoryCounts[category] || 0;
                const baseName = category === 'All' ? 'All' : category;
                tab.textContent = `${baseName} (${count})`;
            });
            
            // Update severity tabs
            document.querySelectorAll('.nav-tab[data-severity]').forEach(tab => {
                const severity = tab.dataset.severity;
                const count = severityCounts[severity] || 0;
                const icon = severity === 'All' ? 'üî•' : severity === 'High' ? 'üö®' : severity === 'Medium' ? '‚ö†Ô∏è' : 'üí°';
                const baseName = severity === 'All' ? 'All Severity' : `${severity} Severity`;
                tab.textContent = `${icon} ${baseName} (${count})`;
            });
        }

        function updateTimestamp() {
            const now = new Date();
            const currentStats = document.getElementById('stats').innerHTML;
            const baseStats = currentStats.split('<span class="sync-time">')[0];
            document.getElementById('stats').innerHTML = baseStats + `<span class="sync-time">Last synced: ${now.toLocaleTimeString()}</span>`;
        }

        function formatTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-load on page load
        window.addEventListener('load', fetchAndCategorize);
    </script>
</body>
</html>